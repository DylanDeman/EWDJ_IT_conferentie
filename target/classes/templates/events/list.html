<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="layout/base :: head">
    <title th:text="#{event.list.title} + ' - ' + #{app.name}">Events</title>
</head>
<body>
<div th:replace="layout/base :: nav"></div>

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col">
            <h1 th:text="#{event.list.title}">Events</h1>
        </div>
        <div class="col-auto" sec:authorize="hasRole('ADMIN')">
            <a th:href="@{/admin/events}" class="btn btn-secondary" th:text="#{event.manage.button}">
                Manage Events
            </a>
            <a th:href="@{/events/new}" class="btn btn-primary me-2" th:text="#{event.create.button}">
                Create New Event
            </a>
        </div>
    </div>

    <!-- Filters with auto-submit using HTML attributes - matched to controller parameters -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="filterForm" th:action="@{/events}" method="get" class="row g-3">
                <div class="col-md-4">
                    <label for="date" class="form-label" th:text="#{event.filter.date}">Date</label>
                    <input type="date" class="form-control" id="date" name="date"
                           th:value="${param.date}"
                           th:min="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}"
                           onchange="this.form.submit();">
                </div>
                <div class="col-md-4">
                    <label for="room" class="form-label" th:text="#{event.filter.room}">Room</label>
                    <select class="form-select" id="room" name="room" onchange="this.form.submit();">
                        <option value="">All Rooms</option>
                        <option th:each="room : ${rooms}"
                                th:value="${room.id}"
                                th:text="${room.name}"
                                th:selected="${param.room != null and param.room[0] == room.id.toString()}">
                            Room Name
                        </option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="sort" class="form-label" th:text="#{event.filter.sort}">Sort By</label>
                    <select class="form-select" id="sort" name="sort" onchange="this.form.submit();">
                        <option value="datetime" th:selected="${param.sort == null or param.sort[0] == 'datetime'}"
                                th:text="#{event.sort.datetime}">Date & Time</option>
                        <option value="name" th:selected="${param.sort != null and param.sort[0] == 'name'}"
                                th:text="#{event.sort.name}">Name</option>
                        <option value="price" th:selected="${param.sort != null and param.sort[0] == 'price'}"
                                th:text="#{event.sort.price}">Price</option>
                    </select>
                </div>
                <div class="col-12">
                    <a th:href="@{/events}" class="btn btn-secondary" th:text="#{event.filter.clear}">Clear Filters</a>
                    <noscript>
                        <button type="submit" class="btn btn-primary">Apply Filters</button>
                    </noscript>
                </div>
            </form>
        </div>
    </div>

    <!-- Events List -->
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        <div th:each="event : ${events}" class="col">
            <div class="card h-100">
                <div class="card-body">
                    <!-- Event Name -->
                    <h5 class="card-title" th:text="${event.name}">Event Name</h5>

                    <!-- Speakers (max 3) -->
                    <p>
                        <strong th:text="#{event.speakers}">Speakers:</strong>
                        <span th:each="speaker, iterStat : ${event.speakers}"
                              th:if="${iterStat.index < 3}"
                              th:text="${speaker.name + (iterStat.last || iterStat.index == 2 ? '' : ', ')}">
                            Speaker
                        </span>
                    </p>

                    <!-- Room -->
                    <p>
                        <strong th:text="#{event.room}">Room:</strong>
                        <span th:text="${event.room.name}">Room</span>
                    </p>

                    <!-- Date and Time -->
                    <p>
                        <strong th:text="#{event.datetime}">Date & Time:</strong>
                        <span th:text="${#temporals.format(event.dateTime, #messages.msg('app.date.format'))}">DateTime</span>
                    </p>
                </div>

                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <a th:href="@{/events/{id}(id=${event.id})}" class="btn btn-primary"
                           th:text="#{event.details.button}">View Details</a>

                        <!-- Admin Controls: Edit / Delete -->
                        <div sec:authorize="hasRole('ADMIN')" class="btn-group ms-2" role="group" aria-label="Manage Event">
                            <a th:href="@{/events/{id}/edit(id=${event.id})}" class="btn btn-sm btn-outline-secondary" 
                               th:text="#{event.edit.button}">Edit</a>

                            <form th:action="@{/events/{id}/delete(id=${event.id})}" method="post" 
                                  onsubmit="return confirm('Are you sure you want to delete this event?');" style="display:inline;">
                                <button type="submit" class="btn btn-sm btn-outline-danger" 
                                        th:text="#{event.delete.button}">Delete</button>
                            </form>
                        </div>

                        <!-- Favorites (optional) -->
                        <div sec:authorize="hasRole('USER')">
                            <form th:if="${userFavorites == null || !#sets.contains(userFavorites, event)}"
                                  th:action="@{/events/{id}/favorite(id=${event.id})}"
                                  method="post" style="display: inline;">
                                <button type="submit" class="btn btn-outline-primary"
                                        th:text="#{favorite.add.button}">
                                    <i class="fas fa-star"></i>
                                </button>
                            </form>
                            <form th:if="${userFavorites != null && #sets.contains(userFavorites, event)}"
                                  th:action="@{/events/{id}/unfavorite(id=${event.id})}"
                                  method="post" style="display: inline;">
                                <button type="submit" class="btn btn-primary"
                                        th:text="#{favorite.remove.button}">
                                    <i class="fas fa-star"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Empty State -->
    <div th:if="${#lists.isEmpty(events)}" class="text-center mt-4">
        <p class="lead" th:text="#{event.list.empty}">No events found matching your criteria.</p>
    </div>
</div>
</body>
</html>